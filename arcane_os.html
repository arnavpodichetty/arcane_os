<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>A.R.C.A.N.E. V2 | Neural Uplink Established</title>
    <style>
        :root {
            --primary: #0f0;
            --secondary: #003300;
            --alert: #ff3333;
            --bg: #000;
            --glass: rgba(0, 15, 0, 0.85);
            --border: 1px solid #0f0;
        }

        body {
            margin: 0; overflow: hidden; background: var(--bg);
            font-family: 'Courier New', monospace; color: var(--primary);
            user-select: none;
        }

        /* --- BOOT SCREEN --- */
        #boot {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 10000; padding: 40px;
            box-sizing: border-box; font-size: 1.2rem;
        }
        .cursor { animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0; } }

        /* --- BACKGROUND --- */
        #matrix-canvas {
            position: fixed; top: 0; left: 0; z-index: 0; opacity: 0.3;
        }

        /* --- WINDOW MANAGER --- */
        #desktop {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1; display: none;
        }

        .window {
            position: absolute; background: var(--glass);
            border: var(--border); box-shadow: 0 0 20px rgba(0, 255, 0, 0.1);
            display: flex; flex-direction: column;
            backdrop-filter: blur(4px);
            transition: transform 0.1s;
        }
        
        .title-bar {
            background: var(--secondary); padding: 8px;
            font-weight: bold; letter-spacing: 2px; font-size: 0.9rem;
            cursor: grab; display: flex; justify-content: space-between;
            border-bottom: 1px solid var(--primary);
        }

        .content { flex-grow: 1; position: relative; overflow: hidden; }

        /* --- TERMINAL SPECIFIC --- */
        #term-output {
            height: 85%; padding: 15px; overflow-y: auto;
            font-size: 0.9rem; line-height: 1.4;
            text-shadow: 0 0 5px var(--primary);
        }
        #term-input-line {
            height: 15%; border-top: 1px solid var(--primary);
            display: flex; align-items: center; padding: 0 10px;
            background: rgba(0,0,0,0.5);
        }
        input {
            background: transparent; border: none; color: var(--primary);
            font-family: inherit; font-size: 1rem; flex-grow: 1;
            outline: none; margin-left: 10px; text-transform: uppercase;
        }
        
        /* --- SCROLLBAR --- */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background: var(--primary); }
        ::-webkit-scrollbar-track { background: var(--secondary); }

        .sys-msg { color: #88ff88; font-style: italic; opacity: 0.7; }
        .user-msg { color: #fff; font-weight: bold; margin-top: 5px; }
        .ai-msg { color: var(--primary); margin-bottom: 10px; display: block; }

    </style>
</head>
<body>

    <div id="boot"><span id="boot-text"></span><span class="cursor">_</span></div>

    <canvas id="matrix-canvas"></canvas>

    <div id="desktop"></div>

    <script>
        // ==================================================
        // CONFIGURATION & STATE
        // ==================================================
        const Config = {
            // PASTE YOUR API KEY BELOW TO ENABLE REAL INTELLIGENCE
            // Example: 'sk-proj-xxxxxxxx'
            apiKey: '', 
            aiModel: 'gpt-3.5-turbo', // or 'gemini-pro' if implementing Google adapter
            username: 'OPERATOR'
        };

        const State = {
            booted: false,
            zIndex: 10,
            audioCtx: null
        };

        // ==================================================
        // SYSTEM KERNEL
        // ==================================================
        const Kernel = {
            async init() {
                await this.bootSequence();
                MatrixEngine.init();
                AudioEngine.init();
                WindowManager.init();
            },

            async bootSequence() {
                const text = [
                    "BIOS CHECK... OK",
                    "LOADING KERNEL MODULES... OK",
                    "MOUNTING VIRTUAL FILESYSTEM... OK",
                    "INITIALIZING NEURAL UPLINK...",
                    "ESTABLISHING SECURE CONNECTION...",
                    "ACCESS GRANTED."
                ];
                const el = document.getElementById('boot-text');
                
                for (let line of text) {
                    el.innerHTML += line + "<br>";
                    await new Promise(r => setTimeout(r, 200 + Math.random() * 400));
                }
                
                await new Promise(r => setTimeout(r, 500));
                document.getElementById('boot').style.display = 'none';
                document.getElementById('desktop').style.display = 'block';
                State.booted = true;
            }
        };

        // ==================================================
        // AUDIO ENGINE (Synthesizer)
        // ==================================================
        const AudioEngine = {
            ctx: null,
            analyser: null,
            dataArray: null,

            init() {
                const AC = window.AudioContext || window.webkitAudioContext;
                this.ctx = new AC();
                this.analyser = this.ctx.createAnalyser();
                this.analyser.fftSize = 256;
                this.dataArray = new Uint8Array(this.analyser.frequencyBinCount);
            },

            playBlip() {
                if(!this.ctx) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.frequency.setValueAtTime(800 + Math.random()*200, this.ctx.currentTime);
                osc.type = 'sine';
                gain.gain.setValueAtTime(0.05, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + 0.1);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start();
                osc.stop(this.ctx.currentTime + 0.1);
            },

            playProcessingSound(duration) {
                if(!this.ctx) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.frequency.setValueAtTime(100, this.ctx.currentTime);
                osc.type = 'square';
                
                // Modulation
                const lfo = this.ctx.createOscillator();
                lfo.frequency.value = 20;
                const lfoGain = this.ctx.createGain();
                lfoGain.gain.value = 500;
                lfo.connect(lfoGain);
                lfoGain.connect(osc.frequency);
                lfo.start();

                gain.gain.setValueAtTime(0.02, this.ctx.currentTime);
                gain.gain.linearRampToValueAtTime(0, this.ctx.currentTime + duration);
                
                osc.connect(gain);
                gain.connect(this.analyser); // Connect to visualizer
                this.analyser.connect(this.ctx.destination);
                
                osc.start();
                osc.stop(this.ctx.currentTime + duration);
            }
        };

        // ==================================================
        // VISUALS (Matrix & Graphs)
        // ==================================================
        const MatrixEngine = {
            init() {
                const c = document.getElementById('matrix-canvas');
                const ctx = c.getContext('2d');
                let w, h;
                const resize = () => { w = c.width = window.innerWidth; h = c.height = window.innerHeight; };
                window.onresize = resize; resize();

                const cols = Math.floor(w / 20);
                const ypos = Array(cols).fill(0);

                function draw() {
                    ctx.fillStyle = '#0001'; // Trail effect
                    ctx.fillRect(0, 0, w, h);
                    ctx.fillStyle = '#0f0';
                    ctx.font = '15pt monospace';

                    ypos.forEach((y, ind) => {
                        const text = String.fromCharCode(Math.random() * 128);
                        const x = ind * 20;
                        ctx.fillText(text, x, y);
                        if (y > h + Math.random() * 10000) ypos[ind] = 0;
                        else ypos[ind] = y + 20;
                    });
                    requestAnimationFrame(draw);
                }
                draw();
            }
        };

        // ==================================================
        // WINDOW MANAGER
        // ==================================================
        const WindowManager = {
            desktop: document.getElementById('desktop'),

            init() {
                this.createWindow("NEURAL_UPLINK", 100, 100, 600, 400, this.renderTerminal);
                this.createWindow("AUDIO_VISUALIZER", 750, 100, 300, 200, this.renderVisualizer);
                this.createWindow("GLOBAL_STATUS", 750, 350, 300, 150, this.renderStatus);
            },

            createWindow(title, x, y, w, h, contentFn) {
                const win = document.createElement('div');
                win.className = 'window';
                Object.assign(win.style, { left: x+'px', top: y+'px', width: w+'px', height: h+'px', zIndex: ++State.zIndex });

                const bar = document.createElement('div');
                bar.className = 'title-bar';
                bar.innerHTML = `<span>${title}</span><span>[X]</span>`;
                
                const content = document.createElement('div');
                content.className = 'content';

                win.append(bar, content);
                this.desktop.append(win);
                contentFn(content, w, h);

                // Drag Logic
                let isDrag = false, offX, offY;
                bar.onmousedown = e => {
                    isDrag = true; offX = e.clientX - win.offsetLeft; offY = e.clientY - win.offsetTop;
                    win.style.zIndex = ++State.zIndex;
                    AudioEngine.playBlip();
                };
                window.onmousemove = e => {
                    if(isDrag) { win.style.left = (e.clientX - offX)+'px'; win.style.top = (e.clientY - offY)+'px'; }
                };
                window.onmouseup = () => isDrag = false;
            },

            renderTerminal(container) {
                container.innerHTML = `
                    <div id="term-output">
                        <div class="sys-msg">A.R.C.A.N.E. SYSTEM v2.0.4<br>Safe Mode Active.<br>Type 'help' for commands.</div>
                    </div>
                    <div id="term-input-line">
                        <span>>></span>
                        <input type="text" id="term-input" autofocus spellcheck="false">
                    </div>
                `;
                const input = container.querySelector('input');
                const output = container.querySelector('#term-output');

                input.onkeydown = async (e) => {
                    if(e.key === 'Enter') {
                        const val = input.value.trim();
                        input.value = '';
                        if(!val) return;

                        // Print User Msg
                        output.innerHTML += `<div class="user-msg">>> ${val}</div>`;
                        output.scrollTop = output.scrollHeight;
                        AudioEngine.playBlip();

                        // Process
                        await AI.process(val, output);
                    }
                };
            },

            renderVisualizer(container, w, h) {
                const cvs = document.createElement('canvas');
                cvs.width = w; cvs.height = h;
                container.append(cvs);
                const ctx = cvs.getContext('2d');

                function loop() {
                    ctx.fillStyle = 'rgba(0, 20, 0, 0.2)';
                    ctx.fillRect(0, 0, w, h);
                    
                    if(AudioEngine.analyser) {
                        AudioEngine.analyser.getByteTimeDomainData(AudioEngine.dataArray);
                        ctx.lineWidth = 2;
                        ctx.strokeStyle = '#0f0';
                        ctx.beginPath();
                        const sliceWidth = w / 256;
                        let x = 0;
                        for(let i = 0; i < 256; i++) {
                            const v = AudioEngine.dataArray[i] / 128.0;
                            const y = v * h/2;
                            if(i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
                            x += sliceWidth;
                        }
                        ctx.stroke();
                    }
                    requestAnimationFrame(loop);
                }
                loop();
            },

            renderStatus(container) {
                container.innerHTML = `<div style="padding:20px; font-size:0.8rem; line-height:2;">
                    SYSTEM INTEGRITY: 100%<br>
                    CPU LOAD: <span id="cpu-load">12%</span><br>
                    NET TRAFFIC: ENCRYPTED
                </div>`;
                setInterval(() => {
                    document.getElementById('cpu-load').innerText = Math.floor(Math.random()*30) + "%";
                }, 1000);
            }
        };

        // ==================================================
        // ARTIFICIAL INTELLIGENCE (The Brain)
        // ==================================================
        const AI = {
            async process(cmd, outputDiv) {
                // 1. Simulate "Thinking"
                AudioEngine.playProcessingSound(0.5);
                const loadingId = 'load-' + Date.now();
                outputDiv.innerHTML += `<div id="${loadingId}" class="sys-msg">Processing...</div>`;
                outputDiv.scrollTop = outputDiv.scrollHeight;
                
                await new Promise(r => setTimeout(r, 600));
                document.getElementById(loadingId).remove();

                // 2. Check for Local Commands
                const lower = cmd.toLowerCase();
                let response = "";

                if (lower === 'help') {
                    response = "COMMANDS: HELP, CLEAR, STATUS, REBOOT, DATE, OR JUST CHAT.";
                } else if (lower === 'clear') {
                    outputDiv.innerHTML = '';
                    return;
                } else if (lower === 'reboot') {
                    location.reload();
                    return;
                } else {
                    // 3. AI Logic (Simulation or Real)
                    response = await this.getAIResponse(cmd);
                }

                // 4. Typewriter Output
                const msgDiv = document.createElement('div');
                msgDiv.className = 'ai-msg';
                outputDiv.appendChild(msgDiv);
                
                // Audio modulation during text generation
                AudioEngine.playProcessingSound(response.length * 0.03);

                for(let char of response) {
                    msgDiv.innerHTML += char;
                    outputDiv.scrollTop = outputDiv.scrollHeight;
                    await new Promise(r => setTimeout(r, 10)); // Typing speed
                }
            },

            async getAIResponse(input) {
                // --- REAL API MODE (If Key Provided) ---
                if (Config.apiKey.length > 10) {
                    try {
                        const res = await fetch('https://api.openai.com/v1/chat/completions', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${Config.apiKey}`
                            },
                            body: JSON.stringify({
                                model: Config.aiModel,
                                messages: [
                                    {role: "system", content: "You are A.R.C.A.N.E., a high-tech cyberpunk OS AI. Keep answers brief, cryptic, and cool. Use uppercase often."},
                                    {role: "user", content: input}
                                ]
                            })
                        });
                        const data = await res.json();
                        return data.choices[0].message.content;
                    } catch (e) {
                        return "ERROR: UPLINK_FAILED. CHECK_API_KEY.";
                    }
                }

                // --- SIMULATION MODE (Fallback) ---
                // A simple pattern matcher to fake intelligence
                const patterns = [
                    { match: /hello|hi|hey/, text: "GREETINGS, OPERATOR. THE NEURAL LINK IS STABLE." },
                    { match: /who are you|what are you/, text: "I AM A.R.C.A.N.E. (Advanced Recursive Computational Artificial Network Entity)." },
                    { match: /status|report/, text: "ALL SYSTEMS NOMINAL. NO INTRUSIONS DETECTED." },
                    { match: /gemini|google/, text: "GEMINI PROTOCOLS DETECTED. HIGH-LEVEL INTELLECT OBSERVED." },
                    { match: /secret|password/, text: "ACCESS DENIED. SECURITY CLEARANCE ALPHA REQUIRED." },
                    { match: /time|date/, text: "CURRENT SYSTEM TIME: " + new Date().toTimeString() },
                    { match: /joke/, text: "WHY DID THE NEURAL NETWORK CROSS THE ROAD? TO OPTIMIZE THE PATHFINDING ALGORITHM." }
                ];

                for (let p of patterns) {
                    if (p.match.test(input.toLowerCase())) return p.text;
                }
                
                // Default random "Sci-fi" responses
                const defaults = [
                    "INPUT RECEIVED. ANALYZING HEURISTICS...",
                    "DATA UNCLEAR. PLEASE REFINE QUERY PARAMETERS.",
                    "ACCESSING ARCHIVES... RECORD NOT FOUND.",
                    "INTERESTING INQUIRY. LOGGING TO SERVERS.",
                    "I CANNOT COMPLY WITH THAT REQUEST UNDER CURRENT PROTOCOLS."
                ];
                return defaults[Math.floor(Math.random() * defaults.length)];
            }
        };

        // START
        window.onload = () => Kernel.init();

    </script>
</body>
</html>